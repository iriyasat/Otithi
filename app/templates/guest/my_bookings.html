{% extends "base.html" %}
{% block title %}My Bookings - Otithi{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
/* My Bookings specific styles */
.bookings-container {
    background-color: var(--neutral-0);
    min-height: 100vh;
    padding: var(--space-6) 0;
    position: relative;
    overflow-x: hidden;
}

.bookings-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 200px;
    background: linear-gradient(180deg, var(--primary-50) 0%, transparent 100%);
    z-index: 0;
    animation: backgroundFloat 6s ease-in-out infinite;
}

.bookings-header {
    background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 50%, var(--primary-400) 100%);
    color: var(--neutral-0);
    padding: var(--space-8) 0;
    margin-bottom: var(--space-8);
    border-radius: 0 0 var(--radius-2xl) var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    position: relative;
    overflow: hidden;
    animation: headerGlow 3s ease-in-out infinite alternate;
}

.bookings-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 4s linear infinite;
    pointer-events: none;
}

.bookings-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent-coral-light), transparent);
    animation: pulse 2s ease-in-out infinite;
}

.bookings-header-content {
    position: relative;
    z-index: 2;
    text-align: center;
}

.bookings-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--space-4);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.bookings-subtitle {
    font-size: var(--font-size-lg);
    opacity: 0.9;
    margin-bottom: 0;
}

.booking-stats {
    margin-bottom: var(--space-8);
}

.stat-card {
    background: var(--neutral-0);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    text-align: center;
    box-shadow: var(--shadow-base);
    border: 1px solid var(--neutral-200);
    transition: all var(--transition-base);
    height: 100%;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-400), var(--accent-coral));
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-200);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--space-4);
    color: var(--primary-600);
    font-size: var(--font-size-2xl);
}

.stat-value {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    color: var(--primary-600);
    margin-bottom: var(--space-2);
}

.stat-label {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.booking-filters {
    background: var(--neutral-0);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin-bottom: var(--space-8);
    box-shadow: var(--shadow-base);
    border: 1px solid var(--neutral-200);
}

.filter-tabs {
    display: flex;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.filter-tab {
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-full);
    border: 2px solid var(--neutral-300);
    background: var(--neutral-0);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-base);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
}

.filter-tab.active {
    border-color: var(--primary-500);
    background: var(--primary-500);
    color: var(--neutral-0);
    box-shadow: var(--shadow-sm);
}

.filter-tab:hover {
    border-color: var(--primary-400);
    color: var(--primary-600);
}

.filter-tab.active:hover {
    color: var(--neutral-0);
}

.booking-card {
    background: var(--neutral-0);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-base);
    margin-bottom: var(--space-6);
    overflow: hidden;
    border: 1px solid var(--neutral-200);
    transition: all var(--transition-base);
}

.booking-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-200);
}

.booking-header-card {
    background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
    color: var(--neutral-0);
    padding: var(--space-6);
    position: relative;
}

.booking-status {
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
}

.booking-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-3);
}

.booking-location {
    opacity: 0.9;
    font-size: var(--font-size-base);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.booking-content {
    padding: var(--space-6);
}

.booking-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-6);
}

.detail-item {
    display: flex;
    align-items: center;
    gap: var(--space-4);
}

.detail-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    background: var(--primary-50);
    color: var(--primary-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-lg);
    flex-shrink: 0;
}

.detail-content strong {
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    display: block;
    margin-bottom: var(--space-1);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.detail-content span {
    color: var(--text-secondary);
    font-size: var(--font-size-base);
}

.booking-actions {
    display: flex;
    gap: var(--space-4);
    flex-wrap: wrap;
    padding-top: var(--space-6);
    border-top: 1px solid var(--neutral-200);
}

.btn-review {
    background: linear-gradient(135deg, var(--accent-coral) 0%, var(--accent-coral-light) 100%);
    border: none;
    color: var(--neutral-0);
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-base);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    box-shadow: var(--shadow-sm);
}

.btn-review:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    color: var(--neutral-0);
    text-decoration: none;
}

.btn-review:disabled {
    background: var(--neutral-400);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-message {
    background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
    border: none;
    color: var(--neutral-0);
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-base);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    box-shadow: var(--shadow-sm);
}

.btn-message:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    color: var(--neutral-0);
    text-decoration: none;
}

.empty-state {
    background: var(--neutral-0);
    border-radius: var(--radius-lg);
    padding: var(--space-16) var(--space-8);
    text-align: center;
    box-shadow: var(--shadow-base);
    border: 2px dashed var(--neutral-300);
}

.empty-state-icon {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-full);
    background: var(--neutral-100);
    color: var(--neutral-400);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--space-6);
    font-size: var(--font-size-4xl);
}

.empty-state h3 {
    color: var(--text-primary);
    margin-bottom: var(--space-4);
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
}

.empty-state p {
    color: var(--text-secondary);
    margin-bottom: var(--space-6);
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
}

.empty-state .btn {
    background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
    border: none;
    color: var(--neutral-0);
    padding: var(--space-4) var(--space-8);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-3);
    transition: all var(--transition-base);
    box-shadow: var(--shadow-sm);
}

.empty-state .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    color: var(--neutral-0);
    text-decoration: none;
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--neutral-0);
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes backgroundFloat {
    0%, 100% { opacity: 0.3; transform: translateY(0); }
    50% { opacity: 0.6; transform: translateY(-10px); }
}

@keyframes headerGlow {
    0% { 
        box-shadow: var(--shadow-xl), 0 0 30px rgba(0, 106, 78, 0.3);
    }
    100% { 
        box-shadow: var(--shadow-xl), 0 0 50px rgba(0, 106, 78, 0.5), 0 0 80px rgba(0, 106, 78, 0.2);
    }
}

@keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

@keyframes pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

/* Responsive design */
@media (max-width: 768px) {
    .booking-stats .col-md-3 {
        margin-bottom: var(--space-4);
    }
    
    .booking-details {
        grid-template-columns: 1fr;
    }
    
    .booking-actions {
        flex-direction: column;
    }
    
    .btn-review,
    .btn-message {
        width: 100%;
        justify-content: center;
    }
    
    .filter-tabs {
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="bookings-container">
    <!-- Bookings Header -->
    <div class="bookings-header">
        <div class="container">
            <div class="bookings-header-content">
                <h1 class="bookings-title">
                    <i class="fas fa-calendar-alt"></i> My Bookings
                </h1>
                <p class="bookings-subtitle">Manage your travel experiences and upcoming trips</p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Booking Statistics -->
        <div class="row booking-stats">
            <div class="col-md-3 mb-4">
                <div class="stat-card" data-stat="total_bookings">
                    <div class="stat-icon">
                        <i class="fas fa-calendar"></i>
                    </div>
                    <div class="stat-value">{{ bookings|length }}</div>
                    <div class="stat-label">Total Bookings</div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card" data-stat="upcoming_trips">
                    <div class="stat-icon">
                        <i class="fas fa-plane"></i>
                    </div>
                    <div class="stat-value">{{ upcoming_checkins|length if upcoming_checkins else 0 }}</div>
                    <div class="stat-label">Upcoming Trips</div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card" data-stat="recent_stays">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-value">{{ recently_completed|length if recently_completed else 0 }}</div>
                    <div class="stat-label">Recent Stays</div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card" data-stat="total_spent">
                    <div class="stat-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="stat-value">৳{{ "%.0f"|format(total_spent or 0) }}</div>
                    <div class="stat-label">Total Spent</div>
                </div>
            </div>
        </div>

        <!-- Booking Filters -->
        <div class="booking-filters">
            <h5 class="mb-4">
                <i class="fas fa-filter"></i> Filter Bookings
            </h5>
            <div class="filter-tabs">
                <div class="filter-tab active" data-filter="all">All Bookings</div>
                <div class="filter-tab" data-filter="confirmed">Confirmed</div>
                <div class="filter-tab" data-filter="completed">Completed</div>
                <div class="filter-tab" data-filter="pending">Pending</div>
            </div>
        </div>

        <!-- Bookings List -->
        {% if bookings and bookings|length > 0 %}
            {% for booking in bookings %}
            <div class="booking-card" data-status="{{ booking.status }}" data-booking-id="{{ booking.id }}">
                <div class="booking-header-card">
                    <div class="booking-status">
                        {{ booking.status.title() }}
                    </div>
                    <h3 class="booking-title">{{ booking.listing.title if booking.listing else 'Unknown Property' }}</h3>
                    <p class="booking-location mb-0">
                        <i class="fas fa-map-marker-alt"></i>
                        {{ booking.listing.location if booking.listing else 'Location not available' }}
                    </p>
                </div>
                
                <div class="booking-content">
                    <div class="booking-details">
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="detail-content">
                                <strong>Check-in</strong>
                                <span>{{ booking.check_in.strftime('%B %d, %Y') if booking.check_in else 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-calendar-times"></i>
                            </div>
                            <div class="detail-content">
                                <strong>Check-out</strong>
                                <span>{{ booking.check_out.strftime('%B %d, %Y') if booking.check_out else 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="detail-content">
                                <strong>Guests</strong>
                                <span>{{ booking.guests }} {{ 'guest' if booking.guests == 1 else 'guests' }}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="detail-content">
                                <strong>Total</strong>
                                <span>৳{{ "%.2f"|format(booking.total_price) }}</span>
                            </div>
                        </div>
                        {% if booking.confirmed_by_name %}
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="detail-content">
                                <strong>Confirmed by</strong>
                                <span>{{ booking.confirmed_by_name }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="booking-actions">
                        {% if booking.status == 'completed' and booking.can_review and not booking.has_reviewed %}
                            <a href="{{ url_for('bookings.review_form', booking_id=booking.id) }}" class="btn-review">
                                <i class="fas fa-star"></i> Write Review
                            </a>
                        {% elif booking.status == 'completed' and booking.has_reviewed %}
                            <button class="btn-review" disabled>
                                <i class="fas fa-check"></i> Already Reviewed
                            </button>
                        {% endif %}
                        
                        {% if booking.listing %}
                            <a href="{{ url_for('listings.listing_detail', listing_id=booking.listing.id) }}" class="btn-message">
                                <i class="fas fa-eye"></i> View Property
                            </a>
                        {% endif %}
                        
                        {% if booking.status == 'confirmed' %}
                            <a href="{{ url_for('messages.chat', user_id=booking.listing.host_id if booking.listing else 0) }}" class="btn-message">
                                <i class="fas fa-comment"></i> Message Host
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-calendar-times"></i>
                </div>
                <h3>No Bookings Yet</h3>
                <p>Start exploring amazing properties and make your first booking to see them here!</p>
                <a href="{{ url_for('main.index') }}" class="btn">
                    <i class="fas fa-search"></i> Explore Properties
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const filterTabs = document.querySelectorAll('.filter-tab');
    const bookingCards = document.querySelectorAll('.booking-card');
    
    filterTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            
            // Update active tab
            filterTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Filter bookings
            bookingCards.forEach(card => {
                const status = card.getAttribute('data-status');
                if (filter === 'all' || status === filter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });

    // Real-time data refresh
    function refreshBookingData() {
        const statCards = document.querySelectorAll('.stat-card[data-stat]');
        
        statCards.forEach(card => {
            card.addEventListener('click', function() {
                const statType = this.getAttribute('data-stat');
                refreshStat(statType);
            });
        });
    }

    function refreshStat(statType) {
        const card = document.querySelector(`[data-stat="${statType}"]`);
        if (!card) return;

        // Add loading state
        card.classList.add('loading');
        const originalContent = card.innerHTML;
        
        // Simulate refresh (in real implementation, this would be an API call)
        setTimeout(() => {
            card.classList.remove('loading');
            // Here you would update with real data from the server
        }, 1000);
    }

    // Auto-refresh every 30 seconds for real-time updates
    setInterval(() => {
        // Refresh booking statuses and counts
        refreshBookingData();
    }, 30000);

    // Initialize
    refreshBookingData();
});
</script>
{% endblock %}
