{% extends "base.html" %}

{% set page_title = "Manage Users" %}

{% block title %}Admin - {{ page_title }} | Otithi{% endblock %}

{% block body_class %}admin-dashboard{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/admin.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="dashboard-container admin-dashboard">
    <!-- Admin Header -->
    <div class="admin-header">
        <div class="container">
            <div class="admin-header-content">
                <h1>
                    <span class="admin-header-icon">
                        <i class="fas fa-users"></i>
                    </span>
                    {{ page_title }}
                </h1>
                <p>Manage user accounts, verification, and roles</p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Stats Cards -->
        <div class="admin-stats-grid">
            <div class="admin-stat-card">
                <div class="admin-stat-icon">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="admin-stat-number">{{ users|selectattr('user_type', 'equalto', 'admin')|list|length }}</div>
                <div class="admin-stat-label">Admins</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-icon">
                    <i class="fas fa-home"></i>
                </div>
                <div class="admin-stat-number">{{ users|selectattr('user_type', 'equalto', 'host')|list|length }}</div>
                <div class="admin-stat-label">Hosts</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="admin-stat-number">{{ users|selectattr('user_type', 'equalto', 'guest')|list|length }}</div>
                <div class="admin-stat-label">Guests</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="admin-stat-number">{{ users|selectattr('verified', 'equalto', true)|list|length }}</div>
                <div class="admin-stat-label">Verified</div>
            </div>
        </div>

        <!-- Users Management Card -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h3>
                    <i class="fas fa-users"></i>
                    All Users
                </h3>
            </div>
            <div class="admin-card-body">
                <!-- Search -->
                <div class="admin-search">
                    <i class="admin-search-icon fas fa-search"></i>
                    <input type="text" class="admin-search-input" placeholder="Search users by name, email, or ID..." id="userSearch">
                </div>

                {% if users %}
                <div class="admin-table-container">
                    <table class="admin-table" id="usersTable">
                        <thead>
                            <tr>
                                <th data-sortable>User</th>
                                <th data-sortable>Type</th>
                                <th data-sortable>Email</th>
                                <th data-sortable>Phone</th>
                                <th data-sortable>Join Date</th>
                                <th data-sortable>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>
                                    <div class="admin-user-info">
                                        {% if user.profile_photo %}
                                            <img src="{{ url_for('static', filename='uploads/' + user.profile_photo) }}" 
                                                 alt="{{ user.full_name }}" 
                                                 class="admin-user-avatar">
                                        {% else %}
                                            <div class="admin-user-avatar-placeholder">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        {% endif %}
                                        <div>
                                            <div class="admin-user-name">{{ user.full_name }}</div>
                                            <small class="admin-user-id">ID: {{ user.id }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="admin-badge admin-badge-{% if user.user_type == 'admin' %}danger{% elif user.user_type == 'host' %}info{% else %}success{% endif %}">
                                        <i class="fas fa-{% if user.user_type == 'admin' %}user-shield{% elif user.user_type == 'host' %}home{% else %}user{% endif %}"></i>
                                        {{ user.user_type.title() }}
                                    </span>
                                </td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.phone or '-' }}</td>
                                <td>
                                    {% if user.join_date %}
                                        {{ user.join_date.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="admin-badge {% if user.verified %}admin-badge-success{% else %}admin-badge-warning{% endif %}">
                                        <i class="fas fa-{% if user.verified %}check-circle{% else %}clock{% endif %}"></i>
                                        {% if user.verified %}Verified{% else %}Unverified{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div class="admin-actions">
                                        <button class="admin-action-btn admin-action-btn-view verification-toggle" 
                                                data-user-id="{{ user.id }}" 
                                                title="{{ 'Unverify User' if user.verified else 'Verify User' }}">
                                            <i class="fas fa-{{ 'times-circle' if user.verified else 'check-circle' }}"></i>
                                        </button>
                                        <a href="{{ url_for('admin.edit_user_confirm', user_id=user.id) }}" 
                                           class="admin-action-btn admin-action-btn-edit" 
                                           title="Edit User">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% if user.id != current_user.id %}
                                        <a href="{{ url_for('admin.delete_user_confirm', user_id=user.id) }}" 
                                           class="admin-action-btn admin-action-btn-delete" 
                                           title="Delete User"
                                           data-action="delete"
                                           data-item-name="{{ user.full_name }}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="admin-empty-state">
                    <i class="fas fa-users"></i>
                    <h5>No users found</h5>
                    <p>Start by adding your first user to the platform.</p>
                </div>
                {% endif %}
                
                <div class="admin-mt-3">
                    <a href="{{ url_for('admin.dashboard') }}" class="admin-btn admin-btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}
