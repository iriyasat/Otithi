{% extends "base.html" %}
{% block title %}Write a Review - Otithi{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
/* Review Form specific styles */
.review-form-container {
    background-color: var(--neutral-0);
    min-height: 100vh;
    padding: var(--space-6) 0;
    position: relative;
    overflow-x: hidden;
}

.review-form-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 200px;
    background: linear-gradient(180deg, var(--primary-50) 0%, transparent 100%);
    z-index: 0;
    animation: backgroundFloat 6s ease-in-out infinite;
}

.review-header {
    background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 50%, var(--primary-400) 100%);
    color: var(--neutral-0);
    padding: var(--space-8) 0;
    margin-bottom: var(--space-8);
    border-radius: 0 0 var(--radius-2xl) var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    position: relative;
    overflow: hidden;
    animation: headerGlow 3s ease-in-out infinite alternate;
    text-align: center;
}

.review-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 4s linear infinite;
    pointer-events: none;
}

.review-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent-coral-light), transparent);
    animation: pulse 2s ease-in-out infinite;
}

.review-header-content {
    position: relative;
    z-index: 2;
}

.review-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--space-4);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-4);
}

.review-title i {
    color: var(--accent-coral);
}

.review-subtitle {
    font-size: var(--font-size-lg);
    opacity: 0.9;
    margin-bottom: 0;
}

.booking-summary {
    background: var(--neutral-0);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin-bottom: var(--space-8);
    box-shadow: var(--shadow-base);
    border: 1px solid var(--neutral-200);
    border-left: 4px solid var(--primary-500);
}

.booking-summary h3 {
    color: var(--text-primary);
    margin-bottom: var(--space-6);
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.booking-summary h3 i {
    color: var(--primary-500);
}

.booking-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-6);
}

.booking-detail {
    display: flex;
    align-items: center;
    gap: var(--space-4);
}

.booking-detail i {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    background: var(--primary-50);
    color: var(--primary-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-lg);
    flex-shrink: 0;
}

.booking-detail span {
    color: var(--text-secondary);
    font-size: var(--font-size-base);
}

.booking-detail strong {
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    display: block;
    margin-bottom: var(--space-1);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.review-form-card {
    background: var(--neutral-0);
    border-radius: var(--radius-lg);
    padding: var(--space-8);
    box-shadow: var(--shadow-base);
    border: 1px solid var(--neutral-200);
}

.review-form h3 {
    color: var(--text-primary);
    margin-bottom: var(--space-8);
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.review-form h3 i {
    color: var(--primary-500);
}

.form-group {
    margin-bottom: var(--space-8);
}

.form-label {
    display: block;
    margin-bottom: var(--space-3);
    color: var(--text-primary);
    font-weight: var(--font-weight-semibold);
    font-size: var(--font-size-base);
}

.rating-input {
    display: flex;
    flex-direction: row-reverse;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
    justify-content: center;
}

.rating-input input[type="radio"] {
    display: none;
}

.rating-input label {
    font-size: var(--font-size-4xl);
    color: var(--neutral-300);
    cursor: pointer;
    transition: color var(--transition-base);
}

.rating-input label:hover,
.rating-input label:hover ~ label,
.rating-input input[type="radio"]:checked ~ label {
    color: var(--accent-coral);
}

.rating-labels {
    display: flex;
    justify-content: space-between;
    color: var(--text-muted);
    font-size: var(--font-size-xs);
    margin-top: var(--space-2);
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

.form-control {
    width: 100%;
    padding: var(--space-4);
    border: 2px solid var(--neutral-300);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-base);
    transition: all var(--transition-base);
    background: var(--neutral-0);
    color: var(--text-primary);
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(0, 106, 78, 0.1);
}

textarea.form-control {
    min-height: 140px;
    resize: vertical;
}

.form-actions {
    display: flex;
    gap: var(--space-4);
    justify-content: flex-end;
    margin-top: var(--space-8);
    padding-top: var(--space-6);
    border-top: 1px solid var(--neutral-200);
}

.btn-cancel {
    background: var(--neutral-500);
    border: none;
    color: var(--neutral-0);
    padding: var(--space-4) var(--space-6);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-base);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    box-shadow: var(--shadow-sm);
}

.btn-cancel:hover {
    background: var(--neutral-600);
    color: var(--neutral-0);
    text-decoration: none;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-submit {
    background: linear-gradient(135deg, var(--accent-coral) 0%, var(--accent-coral-light) 100%);
    border: none;
    color: var(--neutral-0);
    padding: var(--space-4) var(--space-6);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-base);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    box-shadow: var(--shadow-sm);
}

.btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    color: var(--neutral-0);
    text-decoration: none;
}

.btn-submit:disabled {
    background: var(--neutral-400);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.alert {
    padding: var(--space-4);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-6);
    border: 1px solid transparent;
    font-size: var(--font-size-sm);
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.alert-info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb;
}

.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--neutral-0);
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s ease-in-out infinite;
}

.text-muted {
    color: var(--text-muted) !important;
    font-size: var(--font-size-sm);
    margin-top: var(--space-2);
    display: block;
}

.text-danger {
    color: #dc3545 !important;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes backgroundFloat {
    0%, 100% { opacity: 0.3; transform: translateY(0); }
    50% { opacity: 0.6; transform: translateY(-10px); }
}

@keyframes headerGlow {
    0% { 
        box-shadow: var(--shadow-xl), 0 0 30px rgba(0, 106, 78, 0.3);
    }
    100% { 
        box-shadow: var(--shadow-xl), 0 0 50px rgba(0, 106, 78, 0.5), 0 0 80px rgba(0, 106, 78, 0.2);
    }
}

@keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

@keyframes pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

/* Responsive design */
@media (max-width: 768px) {
    .review-form-container {
        padding: var(--space-4) 0;
    }
    
    .booking-details {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn-submit,
    .btn-cancel {
        width: 100%;
        justify-content: center;
    }
    
    .rating-labels {
        font-size: var(--font-size-xs);
        max-width: 300px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="review-form-container">
    <!-- Review Header -->
    <div class="review-header">
        <div class="container">
            <div class="review-header-content">
                <h1 class="review-title">
                    <i class="fas fa-star"></i> Write a Review
                </h1>
                <p class="review-subtitle">Share your experience with other travelers</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Booking Summary -->
                <div class="booking-summary">
                    <h3>
                        <i class="fas fa-info-circle"></i> Stay Details
                    </h3>
                    <div class="booking-details">
                        <div class="booking-detail">
                            <i class="fas fa-home"></i>
                            <div>
                                <strong>Property</strong>
                                <span>{{ booking.listing.title if booking.listing else 'Unknown Property' }}</span>
                            </div>
                        </div>
                        <div class="booking-detail">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <strong>Location</strong>
                                <span>{{ booking.listing.location if booking.listing else 'Location not available' }}</span>
                            </div>
                        </div>
                        <div class="booking-detail">
                            <i class="fas fa-calendar-check"></i>
                            <div>
                                <strong>Check-in</strong>
                                <span>{{ booking.check_in.strftime('%B %d, %Y') if booking.check_in else 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="booking-detail">
                            <i class="fas fa-calendar-times"></i>
                            <div>
                                <strong>Check-out</strong>
                                <span>{{ booking.check_out.strftime('%B %d, %Y') if booking.check_out else 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="booking-detail">
                            <i class="fas fa-users"></i>
                            <div>
                                <strong>Guests</strong>
                                <span>{{ booking.guests }} {{ 'guest' if booking.guests == 1 else 'guests' }}</span>
                            </div>
                        </div>
                        <div class="booking-detail">
                            <i class="fas fa-dollar-sign"></i>
                            <div>
                                <strong>Total</strong>
                                <span>৳{{ "%.2f"|format(booking.total_price) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Review Form -->
                <div class="review-form-card">
                    <form id="reviewForm" method="POST" action="{{ url_for('bookings.submit_review') }}">
                        <input type="hidden" name="booking_id" value="{{ booking.id }}">
                        
                        <div class="review-form">
                            <h3>
                                <i class="fas fa-edit"></i> Your Review
                            </h3>
                            
                            <!-- Rating -->
                            <div class="form-group">
                                <label class="form-label">Overall Rating *</label>
                                <div class="rating-input">
                                    <input type="radio" id="star5" name="rating" value="5" required>
                                    <label for="star5" title="5 stars">★</label>
                                    <input type="radio" id="star4" name="rating" value="4">
                                    <label for="star4" title="4 stars">★</label>
                                    <input type="radio" id="star3" name="rating" value="3">
                                    <label for="star3" title="3 stars">★</label>
                                    <input type="radio" id="star2" name="rating" value="2">
                                    <label for="star2" title="2 stars">★</label>
                                    <input type="radio" id="star1" name="rating" value="1">
                                    <label for="star1" title="1 star">★</label>
                                </div>
                                <div class="rating-labels">
                                    <span>Poor</span>
                                    <span>Fair</span>
                                    <span>Good</span>
                                    <span>Very Good</span>
                                    <span>Excellent</span>
                                </div>
                            </div>
                            
                            <!-- Comment -->
                            <div class="form-group">
                                <label for="comment" class="form-label">Your Review *</label>
                                <textarea 
                                    id="comment" 
                                    name="comment" 
                                    class="form-control" 
                                    placeholder="Share your experience with this property. What did you like? What could be improved? (Minimum 10 characters)"
                                    required 
                                    minlength="10"
                                    maxlength="1000"></textarea>
                                <small class="text-muted">Share details about your stay, the property, cleanliness, communication with the host, and overall experience.</small>
                            </div>
                            
                            <!-- Form Actions -->
                            <div class="form-actions">
                                <a href="{{ url_for('bookings.my_bookings') }}" class="btn-cancel">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                <button type="submit" class="btn-submit" id="submitBtn">
                                    <i class="fas fa-paper-plane"></i> Submit Review
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reviewForm');
    const submitBtn = document.getElementById('submitBtn');
    const ratingInputs = document.querySelectorAll('input[name="rating"]');
    const commentTextarea = document.getElementById('comment');
    
    // Rating star interaction
    ratingInputs.forEach(input => {
        input.addEventListener('change', function() {
            // Remove all active classes
            ratingInputs.forEach(radio => {
                radio.nextElementSibling.classList.remove('active');
            });
            
            // Add active class to selected rating and all stars before it
            if (this.checked) {
                let currentStar = this.nextElementSibling;
                while (currentStar) {
                    currentStar.classList.add('active');
                    currentStar = currentStar.previousElementSibling;
                }
            }
        });
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form
        const rating = document.querySelector('input[name="rating"]:checked');
        const comment = commentTextarea.value.trim();
        
        if (!rating) {
            alert('Please select a rating');
            return;
        }
        
        if (comment.length < 10) {
            alert('Please write a review with at least 10 characters');
            return;
        }
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
        
        // Submit form via AJAX
        fetch('{{ url_for("bookings.submit_review") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(new FormData(form))
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success';
                successAlert.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message;
                form.insertBefore(successAlert, form.firstChild);
                
                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = '{{ url_for("bookings.my_bookings") }}';
                }, 2000);
            } else {
                // Show error message
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger';
                errorAlert.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + data.message;
                form.insertBefore(errorAlert, form.firstChild);
                
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Review';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            
            // Show error message
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger';
            errorAlert.innerHTML = '<i class="fas fa-exclamation-circle"></i> An error occurred. Please try again.';
            form.insertBefore(errorAlert, form.firstChild);
            
            // Reset button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Review';
        });
    });
    
    // Character count for comment
    commentTextarea.addEventListener('input', function() {
        const remaining = 1000 - this.value.length;
        const small = this.nextElementSibling;
        if (remaining < 0) {
            small.textContent = 'Character limit exceeded. Please shorten your review.';
            small.className = 'text-danger';
        } else {
            small.textContent = `Share details about your stay, the property, cleanliness, communication with the host, and overall experience. (${remaining} characters remaining)`;
            small.className = 'text-muted';
        }
    });
});
</script>
{% endblock %}
